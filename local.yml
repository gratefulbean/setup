---

- hosts: localhost
  connection: local
  become: true

  tasks:
    - name: Ensure necessary groups exist
      group:
        name: "{{ item }}"
        state: present
      loop:
        - ansible
        - bean
        - devin

    - name: Ensure necessary users exist
      user:
        name: "{{ item.name }}"
        uid: "{{ item.uid | default(omit) }}"
        group: "{{ item.group }}"
        groups: "{{ item.groups | default(omit) }}"
        state: present
        createhome: yes
        shell: /bin/bash
      loop:
        - { name: ansible, group: root, groups: [] }
        - { name: bean, group: bean, groups: [] }
        - { name: devin, group: devin, uid: 3000, groups: [] }

    - name: Manage authorized SSH keys
      authorized_key:
        user: "{{ item.user }}"
        key: "{{ item.key }}"
        state: "{{ item.state }}"
      loop:
        - { user: ansible, key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIL7ZKCfGHSEDKqwD7MuL/8y0G2rxSyFESJwkcm17vcT8 ansible", state: present }
        - { user: devin, key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKFnKQ3jN447peX7LZL5jPiiEvWYm3pNDIUAu4eRtURj devin@acer-chromebook", state: present }
        - { user: bean, key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIx7pxPl9zOUCRwBoo9EfDT9Knx/ssU01FFftP6M21Kj bean@rivendell", state: absent }

    - name: Copy .bashrc files
      copy:
        src: files/bashrc
        dest: "/home/{{ item.user }}/.bashrc"
        owner: "{{ item.user }}"
        group: "{{ item.user }}"
        mode: "0644"
      loop:
        - { user: bean }
        - { user: devin }

    - name: Remove sudo privileges for devin
      file:
        path: "/etc/sudoers.d/devin"
        state: absent
      ignore_errors: yes

    - name: Update SSH configuration
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?{{ item.key }}'
        line: "{{ item.line }}"
      loop:
        - { key: 'Port ', line: 'Port 22' }
        - { key: 'PermitRootLogin', line: 'PermitRootLogin no' }
        - { key: 'PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { key: 'PasswordAuthentication', line: 'PasswordAuthentication no' }
      notify: Restart SSH

    - name: add sudo priveleges file for devin
      tags: always
      become: yes
      copy:
        src: sudoer_devin
        dest: /etc/sudoers.d/devin
        owner: root
        group: root
        mode: 0440


    - name: Copy sudoers file for user ansible
      tags: always
      become: yes
      copy:
        src: files/sudoer_ansible
        dest: /etc/sudoers.d/ansible
        owner: root
        group: root
        mode: '0440'
